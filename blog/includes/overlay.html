<script>
  // If an overlay is found, add controls.
  function FloatyOverlay(overlay){
    let overlay_content = overlay.querySelector(".overlay-content")
    if (!overlay_content) throw Error("Could not find overlay content.")

    let overlay_content_children = Array.from(overlay_content.getElementsByClassName("overlay-content-item"))

    function hideOverlay() {
      overlay.style.display = "none";
      overlay_content.style.display = "none"
      overlay_content_children.map(child => {child.style.display = 'none'})
    }

    function showOverlay() {
      overlay.style.display = "flex";
      overlay_content.style.display = "block";
    }

    function onClick (icon_or_row) {
      return function() {
        showOverlay()
        overlay_content_children[icon_or_row.dataset.key].style.display = 'block'
      }
    }

    hideOverlay(name)
    overlay.addEventListener("click", hideOverlay)

    return { hideOverlay, showOverlay, overlay, overlay_content, overlay_content_children, onClick }
  }

  // Set up floaty with ``id=name``.
  function Floaty(name, {li_margin}) {
    let parent = document.getElementById(name)
    if (!parent) throw Error(`Could not find element with name \`${name}\`.`)

    let floaty_container = parent.querySelector(".floaty-container")
    if (!floaty_container) throw Error(`Could not find element with name \`${floaty_container}\`.`)

    let overlay = parent.querySelector(".overlay")
    overlay_controls = !overlay ? null : FloatyOverlay(overlay)

    function setListItemSize(icon_in_li){
      const size = parseInt(icon_in_li.style['font-size'])

      // NOTE: This makes it so that size should always be specified in pixels.
      const li = icon_in_li.closest("li")
      if (li){
        li.style.height = `${size}px`
        li.style.width = `${size}px`
        li.style.margin = li_margin || `${(size / 4)}px`
      }
    }

    function setOnClick(icons)
    {
      let ul = parent.querySelector(".floaty-container ul")
      let table = parent.querySelector(".floaty-container table")
      if (table) {
        icons.map(icon => {
          if (overlay) icon.closest("tr").addEventListener("click", overlay_controls.onClick(icon))
        })
      }
      else if (ul) {
        icons.map(icon => {
          if (overlay) icon.addEventListener("click", overlay_controls.onClick(icon))
          setListItemSize(icon)
        })
      }
      else {
        console.error("No `ul` or `table` found.")
      }
    }


    // NOTE: For now, clicking anywhere on the overlay should hide it.
    let icons = Array.from(floaty_container.getElementsByTagName("iconify-icon"))
    setOnClick(icons)


    return { icons, overlay }
  }

</script>

