<script>
  // If an overlay is found, add controls.
  function FloatyOverlay(overlay){
    let overlay_content = overlay.querySelector(".overlay-content")
    if (!overlay_content) throw Error("Could not find overlay content.")

    let overlay_content_children = Array.from(overlay_content.getElementsByClassName("overlay-content-item"))

    function hideOverlay() {
      overlay.style.display = "none";
      overlay_content.style.display = "none"
      overlay_content_children.map(child => {child.style.display = 'none'})
    }

    function showOverlay() {
      overlay.style.display = "flex";
      overlay_content.style.display = "block";
    }

    function onClick (icon_or_row) {
      return function() {
        showOverlay()
        let content = overlay_content_children.find(item => item.dataset.key == icon_or_row.dataset.key)
        if (!content) throw Error(`Could not find content for \`${icon_or_row.dataset.key}\`.`)
        content.style.display = 'block'
      }
    }

    hideOverlay(name)
    overlay.addEventListener("click", hideOverlay)

    return { hideOverlay, showOverlay, overlay, overlay_content, overlay_content_children, onClick }
  }

  // Set up floaty with ``id=name``.
  function Floaty(name, {li_margin, kind}) {
    let parent = document.getElementById(name)
    if (!parent) throw Error(`Could not find element with name \`${name}\`.`)

    let floaty_container = parent.querySelector(".floaty-container")
    if (!floaty_container) throw Error(`Could not find element with name \`${floaty_container}\`.`)

    let overlay = parent.querySelector(".overlay")
    overlay_controls = !overlay ? null : FloatyOverlay(overlay)

    function setUpListItem(icon_in_li){
      const size = parseInt(icon_in_li.style['font-size'])

      // NOTE: This makes it so that size should always be specified in pixels.
      const li = icon_in_li.closest("li")
      if (li){
        li.style.height = `${size}px`
        li.style.width = `${size}px`
        li.style.margin = li_margin || `${(size / 4)}px`
      }

      // NOTE: Icon and its list item should be clickable.
      if (overlay) li.addEventListener("click", overlay_controls.onClick(icon_in_li))
    }

    function setOnClick(icons)
    {
      // NOTE: It is important that nested does not go beyond its floaty.
      //       Table gets found when nested inside.
      if (kind === "table") {
        let table = parent.querySelector(".floaty-container table")
        if ( !table ) {
          console.error("No `table` found.")
          return
        }
        icons.map(icon => {
          if (overlay) {
            tr = icon.closest("tr")
            if (!tr) {
              console.error("Expected table row for icon.", icon)
              return
            }
            tr.addEventListener("click", overlay_controls.onClick(icon))
          }
        })
      }
      else {
        let ul = parent.querySelector(".floaty-container ul")
        if ( !ul ) console.error("No `ul` found.")
        icons.map(icon => setUpListItem(icon))
      }
    }


    // NOTE: For now, clicking anywhere on the overlay should hide it.
    let icons = Array.from(floaty_container.getElementsByTagName("iconify-icon"))
    setOnClick(icons)


    return { icons, overlay_controls }
  }

</script>

