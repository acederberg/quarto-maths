<script>

  function Overlay(name, li_margin) {
    let parent = document.getElementById(name)
    let floaty_container = parent.getElementsByClassName("floaty-container")[0]
    let overlay = Array.from(parent.getElementsByClassName("overlay"))[0]
    let overlay_content = Array.from(parent.getElementsByClassName("overlay-content"))[0]
    let overlay_content_children = Array.from(overlay_content.getElementsByClassName("overlay-content-item"))

    // console.log("===================================")
    // console.log(name)
    // console.log(parent)
    // console.log(floaty_container)
    // console.log(overlay)

    if (!floaty_container) { console.error(`Could not find floaty.`) }
    if (!overlay) { console.error(`Could not find overlay for \`${name}\`.`) }
    if (!overlay_content) { console.error(`Could not find overlay_content for \`${name}\`.`) }

    function hideOverlay() {
      overlay.style.display = "none";
      overlay_content.style.display = "none"
      overlay_content_children.map(child => {child.style.display = 'none'})
    }

    function showOverlay() {
      overlay.style.display = "flex";
      overlay_content.style.display = "block";
    }

    function onClick (icon_or_row) {
      return function() {
        showOverlay()
        overlay_content_children[icon_or_row.dataset.key].style.display = 'block'
      }
    }

    function setListItemSize(icon_in_li){
      const size = parseInt(icon_in_li.style['font-size'])

      // NOTE: This makes it so that size should always be specified in pixels.
      const li = icon_in_li.closest("li")
      if (li){
        li.style.height = `${size}px`
        li.style.width = `${size}px`
        li.style.margin = `${li_margin || (size / 4)}px`
      }
    }

    function setOnClick(icons)
    {
      let ul = parent.querySelector(".floaty-container ul")
      let table = parent.querySelector(".floaty-container table")
      // console.log("ul", ul)
      // console.log("table", table)
      if (table) {
        icons.map(icon => {
          icon.closest("tr").addEventListener("click", onClick(icon))
        })
      }
      else if (ul) {
        icons.map(icon => {
          icon.addEventListener("click", onClick(icon))
          if (ul) setListItemSize(icon)
        })
      }
      else {
        console.error("No `ul` or `table` found.")
      }
    }


    // NOTE: For now, clicking anywhere on the overlay should hide it.
    let icons = Array.from(floaty_container.getElementsByTagName("iconify-icon"))

    setOnClick(icons)

    hideOverlay(name)
    overlay.addEventListener("click", hideOverlay)

    return { icons, hideOverlay, showOverlay, overlay, overlay_content, overlay_content_children }
  }

</script>

